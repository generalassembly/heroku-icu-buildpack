#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

mkdir -p "$BUILD_DIR/app"

if [[ -d "$CACHE_DIR/icu" ]]; then
  echo "Using cached build of ICU"
  cp -R "$CACHE_DIR/icu" "$BUILD_DIR/app/icu"
  cp -R "$CACHE_DIR/icu" "/app/icu"
else
  echo "Building ICU"
  pushd icu-src

  ./runConfigureICU Linux --prefix=/app/icu
  make
  make install

  popd

  cp -R "/app/icu" "$CACHE_DIR/icu"
  cp -R "/app/icu" "$BUILD_DIR/app/icu"
fi

export BUNDLE_BUILD__CHARLOCK_HOLMES="--with-icu-dir=/app/icu"

#give environment to later buildpacks
export | grep -E -e ' (BUNDLE_BUILD__CHARLOCK_HOLMES)='  > "$LP_DIR/export"
