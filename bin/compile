#!/bin/bash

LP_DIR=`cd $(dirname $0); cd ..; pwd`

compile="/app/icu"
build="$1/icu"
cache="$2/icu"

if [[ -d "$CACHE_DIR/icu" ]]; then
  echo "Using cached build of ICU"
  cp -R $cache $build
  cp -R $cache $compile
else
  echo "Building ICU"

  tar -xzf icu.tar.gz

  pushd icu-src

  ./runConfigureICU Linux --prefix=$compile
  make
  make install

  popd

  cp -R $compile $cache
  cp -R $compile $build
fi

# Tell Charlock Holmes where to find ICU.
export BUNDLE_BUILD__CHARLOCK_HOLMES="--with-icu-dir=$compile"

cat $BUNDLE_BUILD__CHARLOCK_HOLMES > "$3/BUNDLE_BUILD__CHARLOCK_HOLMES"
echo "$LP_DIR"
ls $LP_DIR

#give environment to later buildpacks
export | grep -E -e '(BUNDLE_BUILD__CHARLOCK_HOLMES)='  > "$LP_DIR/export"
